<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/cli.css"/>
    <!--<link rel="stylesheet" href="bower_components/primeui/themes/delta/theme.css" />-->
    <link rel="stylesheet" type="text/css" href="bower_components/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="bower_components/jquery-ui/themes/base/jquery-ui.css" />
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="bower_components/jquery-ui/jquery-ui.js"></script>
    <script type="text/javascript" src="bower_components/angular/angular.js"></script>
    <script type="text/javascript" src="bower_components/angular-resource/angular-resource.js"></script>
    <script type="text/javascript">
/*global angular*/
/*global $*/
angular
        .module("client", ["ngResource"])
        .constant("config", {
            endPoint: "http://localhost:8080/mini/api/rest"
        })
        .config(["$resourceProvider", function($resourceProvider){
            "use strict";
            $resourceProvider.defaults.stripTrailingSlashes = false;
        }])
        .controller("indexController", ["$log", "$scope", "$resource", "config", function($log, $scope, $resource, config){
            "use strict";
            var queryResource = $resource(config.endPoint + "/binders/query", {}, {
                "query": { method: "POST", isArray: true }
            });
            var binderResource = $resource(config.endPoint + "/binders/:binderIds");
            $scope.binderQuery = {};

            $scope.query = function(){
                $log.log("querying:", angular.toJson($scope.binderQuery));
                $scope.results = queryResource.query($scope.binderQuery, function(results){
                    binderResource.get({binderIds: results.join(",")}, function(model){
                        var map = {};
                        // process model, rebuild relationships
                        $scope.binders = model.binders;
                        angular.forEach(model.binders, function(binder){
                            map["b" + binder.id] = binder;
                            binder.dockets = [];
                        });
                        angular.forEach(model.courts, function(court){
                            map["c" + court.id] = court;
                        });
                        angular.forEach(model.dockets, function(docket){
                            map["o" + docket.id] = docket;
                            docket.decisions = [];
                            docket.court = map["c" + docket.courtId];
                            map["b" + docket.binderId].dockets.push(docket);
                        });
                        angular.forEach(model.decisions, function(decision){
                            map["d" + decision.id] = decision;
                            map["o" + decision.docketId].decisions.push(decision);

                        });
                    });
                });
            };
        }])
        .directive("binderPanel", ["$log", function($log){
            "use strict";
            return {
                restrict: "E",
                scope: {
                    binder: "="
                },
                templateUrl: "partials/binder-panel.html"
            };
        }])
        .directive("docketPanel", ["$log", function($log){
            "use strict";
            return {
                restrict: "E",
                scope: {
                    docket: "="
                },
                templateUrl: "partials/docket-panel.html"
            };
        }])
        .directive("decisionPanel", ["$log", function($log){
            "use strict";
            return {
                restrict: "E",
                scope: {
                    decision: "="
                },
                templateUrl: "partials/decision-panel.html"
            };
        }])
        .directive("courtPanel", ["$log", function($log){
            "use strict";
            return {
                restrict: "E",
                scope: {
                    court: "="
                },
                templateUrl: "partials/court-panel.html"
            };
        }])
    </script>
</head>
<body data-ng-app="client" data-ng-controller="indexController">
coucou {{coucou}}
<input type="text" data-ng-model="binderQuery.reference" placeholder="Reference"/>
<br/>
<button data-ng-click="query()">Query</button>
<br/>
results: {{results}}
<div data-ng-repeat="binder in binders">
    <binder-panel binder="binder"></binder-panel>
</div>
</body>
</html>